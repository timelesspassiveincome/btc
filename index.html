<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>PDF Slide Viewer</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

<style>
:root { --vh: 1vh; }

body {
  margin: 0;
  background: #000;
  overflow: hidden;
}

main {
  width: 100%;
  height: calc(var(--vh) * 100);
}

.pdf-wrapper {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
}

#pdf-canvas {
  max-width: 100%;
  max-height: 100%;
  touch-action: none;
}

.bottom-nav {
  position: fixed;
  bottom: 1rem;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0,0,0,.55);
  backdrop-filter: blur(8px);
  border-radius: 999px;
  padding: .4rem .8rem;
  display: flex;
  gap: .75rem;
  align-items: center;
  z-index: 1500;
}

.bottom-nav button {
  border: none;
  background: transparent;
  color: #fff;
  font-size: 1.2rem;
}

#page-info {
  color: #fff;
  font-size: .85rem;
}

.fullscreen-btn,
.exit-fs-btn,
.fit-btn {
  position: fixed;
  right: 1rem;
  width: 44px;
  height: 44px;
  border-radius: 50%;
  border: none;
  background: rgba(0,0,0,.6);
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1600;
}

.fullscreen-btn { bottom: 1rem; }
.fit-btn { bottom: 4.5rem; }
.exit-fs-btn { top: 1rem; display: none; }

.hidden { opacity: 0; pointer-events: none; }
</style>
</head>

<body>

<main>
  <div class="pdf-wrapper" id="viewer">
    <canvas id="pdf-canvas"></canvas>
  </div>
</main>

<div class="bottom-nav" id="bottomNav">
  <button id="prev"><i class="bi bi-chevron-left"></i></button>
  <span id="page-info"></span>
  <button id="next"><i class="bi bi-chevron-right"></i></button>
</div>

<button class="fullscreen-btn" id="fsBtn">
  <i class="bi bi-arrows-fullscreen"></i>
</button>

<button class="fit-btn" id="fitBtn">
  <i class="bi bi-aspect-ratio"></i>
</button>

<button class="exit-fs-btn" id="exitFsBtn">
  <i class="bi bi-x-lg"></i>
</button>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

<script>
/* ===== VH Fix ===== */
function setVH() {
  document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
}
window.addEventListener('resize', () => {
  setVH();
  renderPage(pageNum);
});
setVH();

/* ===== PDF Setup ===== */
const pdfUrl = 'file/bitcoin.pdf';
pdfjsLib.GlobalWorkerOptions.workerSrc =
  'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

let pdfDoc;
let pageNum = Number(localStorage.getItem('lastPage')) || 1;
let zoomScale = 1;
let fitScale = 1;
let fitMode = localStorage.getItem('fitMode') || 'screen';

const canvas = document.getElementById('pdf-canvas');
const ctx = canvas.getContext('2d');
const viewer = document.getElementById('viewer');
const pageInfo = document.getElementById('page-info');

/* ===== Fit Scale ===== */
function calcFitScale(page) {
  const vp = page.getViewport({ scale: 1 });
  const scaleX = viewer.clientWidth / vp.width;
  const scaleY = viewer.clientHeight / vp.height;
  return fitMode === 'width'
    ? scaleX
    : Math.min(scaleX, scaleY);
}

/* ===== Render ===== */
async function renderPage(num) {
  const page = await pdfDoc.getPage(num);
  fitScale = calcFitScale(page);

  const viewport = page.getViewport({
    scale: fitScale * zoomScale
  });

  canvas.width = viewport.width;
  canvas.height = viewport.height;

  ctx.clearRect(0,0,canvas.width,canvas.height);
  page.render({ canvasContext: ctx, viewport });

  pageInfo.textContent = `${num} / ${pdfDoc.numPages}`;
  localStorage.setItem('lastPage', num);
}

pdfjsLib.getDocument(pdfUrl).promise.then(pdf => {
  pdfDoc = pdf;
  if (pageNum > pdf.numPages) pageNum = 1;
  renderPage(pageNum);
});

/* ===== Navigation ===== */
prev.onclick = () => pageNum > 1 && renderPage(--pageNum);
next.onclick = () => pageNum < pdfDoc.numPages && renderPage(++pageNum);

/* ===== Pinch Zoom ===== */
let startDist = 0, tempScale = 1, isPinching = false;
const dist = e => Math.hypot(
  e.touches[0].clientX - e.touches[1].clientX,
  e.touches[0].clientY - e.touches[1].clientY
);

canvas.addEventListener('touchstart', e => {
  if (e.touches.length === 2) {
    isPinching = true;
    startDist = dist(e);
  }
});

canvas.addEventListener('touchmove', e => {
  if (!isPinching) return;
  e.preventDefault();
  tempScale = Math.min(Math.max(zoomScale * (dist(e)/startDist),1),3);
  canvas.style.transform = `scale(${tempScale})`;
},{passive:false});

canvas.addEventListener('touchend', () => {
  if (isPinching) {
    zoomScale = tempScale;
    canvas.style.transform = 'none';
    isPinching = false;
    renderPage(pageNum);
  }
});

/* ===== Double Tap Reset ===== */
let lastTap = 0;
canvas.addEventListener('touchend', () => {
  const now = Date.now();
  if (now - lastTap < 300) {
    zoomScale = 1;
    renderPage(pageNum);
  }
  lastTap = now;
});

/* ===== Swipe Page ===== */
let sx = 0;
canvas.addEventListener('touchstart', e => {
  if (e.touches.length === 1 && zoomScale === 1)
    sx = e.touches[0].clientX;
});
canvas.addEventListener('touchend', e => {
  if (zoomScale !== 1) return;
  const dx = e.changedTouches[0].clientX - sx;
  if (Math.abs(dx) > 80)
    dx < 0 ? next.click() : prev.click();
});

/* ===== Fullscreen ===== */
fsBtn.onclick = async () => {
  if (!document.fullscreenElement) {
    await viewer.requestFullscreen();
    try { screen.orientation.lock('landscape'); } catch {}
  } else document.exitFullscreen();
};

exitFsBtn.onclick = () => document.exitFullscreen();

document.addEventListener('fullscreenchange', () => {
  const isFs = document.fullscreenElement;
  exitFsBtn.style.display = isFs ? 'flex' : 'none';
  fsBtn.innerHTML = isFs
    ? '<i class="bi bi-fullscreen-exit"></i>'
    : '<i class="bi bi-arrows-fullscreen"></i>';
  if (!isFs && screen.orientation?.unlock)
    screen.orientation.unlock();
  setTimeout(()=>renderPage(pageNum),200);
});

/* ===== Fit Toggle ===== */
fitBtn.onclick = () => {
  fitMode = fitMode === 'screen' ? 'width' : 'screen';
  localStorage.setItem('fitMode', fitMode);
  fitBtn.innerHTML = fitMode === 'screen'
    ? '<i class="bi bi-aspect-ratio"></i>'
    : '<i class="bi bi-arrows-angle-expand"></i>';
  zoomScale = 1;
  renderPage(pageNum);
};

/* ===== Tap Toggle UI ===== */
viewer.addEventListener('click', () => {
  bottomNav.classList.toggle('hidden');
  fsBtn.classList.toggle('hidden');
  fitBtn.classList.toggle('hidden');
});

/* ===== Auto Exit FS on Portrait ===== */
window.addEventListener('orientationchange', () => {
  if (screen.orientation?.type.startsWith('portrait') &&
      document.fullscreenElement) {
    document.exitFullscreen();
  }
});
</script>
</body>
</html>
